<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Regeneration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vector Encoding System Fix - Testing Interface</h1>
        
        <div class="section">
            <h2>Current Status</h2>
            <div id="status">Loading...</div>
        </div>

        <div class="section">
            <h2>User Vector Regeneration</h2>
            <button class="button" onclick="regenerateUserVector('0debd257-a63a-4ccf-83a8-6c3ee17a2bf2', 'Azmil')">
                Regenerate Azmil's Vector
            </button>
            <button class="button" onclick="regenerateUserVector('a7ed4757-5983-4112-967f-b678430248f9', 'Omar')">
                Regenerate Omar's Vector
            </button>
            <div id="userResults"></div>
        </div>

        <div class="section">
            <h2>Match Vector Regeneration</h2>
            <button class="button" onclick="regenerateMatchVector('b782da26-e2ea-43a3-b33f-49b2fb4d7a11', 'Basketball Match')">
                Regenerate Basketball Match
            </button>
            <button class="button" onclick="regenerateMatchVector('fca24a30-dd07-45c8-9ba5-4a42cc259159', 'Basketball Match 2')">
                Regenerate Basketball Match 2
            </button>
            <div id="matchResults"></div>
        </div>

        <div class="section">
            <h2>Similarity Testing</h2>
            <button class="button" onclick="testSimilarity()">Test Current Similarity Scores</button>
            <div id="similarityResults"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fcwwuiitsghknsvnsrxp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjd3d1aWl0c2doa25zdm5zcnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc2NjI4MTgsImV4cCI6MjA2MzIzODgxOH0.5IkK_9D4FZU3z_4Kpm7pRJu8rIKfKleIpxMbyr-YoBA';

        async function callEdgeFunction(functionName, data) {
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                return { success: response.ok, data: result, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function regenerateUserVector(userId, userName) {
            const resultDiv = document.getElementById('userResults');
            resultDiv.innerHTML += `<div class="result">Regenerating vector for ${userName}...</div>`;

            const result = await callEdgeFunction('generate-user-embeddings-v2', { userId });
            
            if (result.success) {
                resultDiv.innerHTML += `<div class="result success">✅ ${userName} vector regenerated successfully!\nResponse: ${JSON.stringify(result.data, null, 2)}</div>`;
            } else {
                resultDiv.innerHTML += `<div class="result error">❌ Failed to regenerate ${userName} vector\nError: ${JSON.stringify(result, null, 2)}</div>`;
            }
        }

        async function regenerateMatchVector(matchId, matchName) {
            const resultDiv = document.getElementById('matchResults');
            resultDiv.innerHTML += `<div class="result">Regenerating vector for ${matchName}...</div>`;

            const result = await callEdgeFunction('generate-match-embeddings', { matchId });
            
            if (result.success) {
                resultDiv.innerHTML += `<div class="result success">✅ ${matchName} vector regenerated successfully!\nResponse: ${JSON.stringify(result.data, null, 2)}</div>`;
            } else {
                resultDiv.innerHTML += `<div class="result error">❌ Failed to regenerate ${matchName} vector\nError: ${JSON.stringify(result, null, 2)}</div>`;
            }
        }

        async function testSimilarity() {
            const resultDiv = document.getElementById('similarityResults');
            resultDiv.innerHTML = `<div class="result">Testing similarity calculations...</div>`;

            // Call the simplified recommendations function to get current similarity scores
            const result = await callEdgeFunction('simplified-recommendations', { 
                userId: '0debd257-a63a-4ccf-83a8-6c3ee17a2bf2',
                limit: 5 
            });
            
            if (result.success) {
                resultDiv.innerHTML += `<div class="result success">✅ Current Similarity Scores:\n${JSON.stringify(result.data, null, 2)}</div>`;
            } else {
                resultDiv.innerHTML += `<div class="result error">❌ Failed to get similarity scores\nError: ${JSON.stringify(result, null, 2)}</div>`;
            }
        }

        // Load initial status
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('status').innerHTML = `
                <div class="result">
                    <strong>Test Users:</strong><br>
                    • Azmil: 0debd257-a63a-4ccf-83a8-6c3ee17a2bf2 (casual play style)<br>
                    • Omar: a7ed4757-5983-4112-967f-b678430248f9 (competitive play style)<br><br>
                    
                    <strong>Test Matches:</strong><br>
                    • Basketball Match 1: b782da26-e2ea-43a3-b33f-49b2fb4d7a11<br>
                    • Basketball Match 2: fca24a30-dd07-45c8-9ba5-4a42cc259159<br><br>
                    
                    <strong>Expected Improvements:</strong><br>
                    • Basketball: 16% → 70-90% (with unified vector schema)<br>
                    • Volleyball: 13% → 70-90% (with unified vector schema)<br>
                </div>
            `;
        });
    </script>
</body>
</html>
